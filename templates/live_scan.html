{% extends "base.html" %}

{% block title %}Live Scan · Riftcollector{% endblock %}

{% block content %}
  <h1>Live Scan</h1>
  <div class="meta">
    {{ card_count }} cards indexed · {{ image_count }} images loaded
  </div>

  <div class="layout">
    <div class="panel">
      <h2>Hold a card in the frame</h2>
      <div style="position: relative; width: 100%; max-width: 640px;">
        <video id="liveCamera" autoplay playsinline muted style="width: 100%; height: auto; border-radius: 12px;"></video>
        <canvas id="liveOverlay" style="position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
      </div>
      <canvas id="liveCanvas" hidden></canvas>
      <div class="camera-actions" style="margin-top: 12px;">
        <button id="btnStart" type="button">Start Camera</button>
        <button id="btnStop" class="secondary" type="button" disabled>Stop</button>
      </div>
      <div id="statusText" class="result" style="margin-top: 12px;">Click "Start Camera" to begin scanning.</div>
    </div>

    <div class="panel">
      <h2>Pending Matches</h2>
      <div class="meta">Confirm cards before adding to your collection.</div>
      <div id="pendingList" class="result" style="min-height: 100px;">
        <div id="pendingEmpty" style="color: #64748b;">No cards scanned yet.</div>
      </div>
      <div class="camera-actions" style="margin-top: 12px;">
        <button id="btnClearPending" class="secondary" type="button" disabled>Clear All</button>
        <button id="btnAddToCollection" type="button" disabled>Add to Collection</button>
      </div>
      <div id="collectionStatus" class="result" style="margin-top: 12px; display: none;"></div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal-backdrop" style="display: none;">
    <div class="modal" role="dialog" aria-modal="true">
      <img id="modalImage" class="modal-preview" alt="Matched card" style="max-width: 200px; border-radius: 8px;" />
      <h3 id="modalTitle">Card Detected</h3>
      <p id="modalMeta" style="color: #94a3b8;"></p>
      <div class="modal-actions">
        <button id="btnConfirmYes" type="button">Yes, Add It</button>
        <button id="btnConfirmNo" class="secondary" type="button">No, Skip</button>
      </div>
    </div>
  </div>

  <style>
    .pending-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: #1e293b;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .pending-card img {
      width: 50px;
      height: 70px;
      object-fit: cover;
      border-radius: 4px;
    }
    .pending-card-info {
      flex: 1;
    }
    .pending-card-name {
      font-weight: 600;
      color: #f1f5f9;
    }
    .pending-card-meta {
      font-size: 0.85em;
      color: #64748b;
    }
    .pending-card button {
      padding: 4px 8px;
      font-size: 0.85em;
    }
  </style>

  <script>
    const liveCamera = document.getElementById("liveCamera");
    const liveCanvas = document.getElementById("liveCanvas");
    const liveOverlay = document.getElementById("liveOverlay");
    const overlayCtx = liveOverlay.getContext("2d");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const statusText = document.getElementById("statusText");
    const pendingList = document.getElementById("pendingList");
    const pendingEmpty = document.getElementById("pendingEmpty");
    const btnClearPending = document.getElementById("btnClearPending");
    const btnAddToCollection = document.getElementById("btnAddToCollection");
    const collectionStatus = document.getElementById("collectionStatus");
    
    const confirmModal = document.getElementById("confirmModal");
    const modalImage = document.getElementById("modalImage");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const btnConfirmYes = document.getElementById("btnConfirmYes");
    const btnConfirmNo = document.getElementById("btnConfirmNo");

    let cameraStream = null;
    let scanTimer = null;
    let isScanning = false;
    let pendingCards = [];
    let currentMatch = null;
    let lastMatchId = null;
    let matchCount = 0;

    const SCAN_INTERVAL = 400;
    const MATCH_THRESHOLD = 28;
    const STABILITY_REQUIRED = 2;
    const ROI_SCALE = 0.7;

    function setStatus(msg, isError = false) {
      statusText.innerHTML = isError 
        ? `<span style="color: #f87171;">${msg}</span>` 
        : msg;
    }

    function updatePendingUI() {
      pendingEmpty.style.display = pendingCards.length ? "none" : "block";
      btnClearPending.disabled = !pendingCards.length;
      btnAddToCollection.disabled = !pendingCards.length;
      
      // Render pending cards
      const cardsHtml = pendingCards.map((card, idx) => `
        <div class="pending-card" data-idx="${idx}">
          <img src="${card.image_url}" alt="${card.name}" />
          <div class="pending-card-info">
            <div class="pending-card-name">${card.name}</div>
            <div class="pending-card-meta">Distance: ${card.distance}</div>
          </div>
          <button class="secondary remove-pending" data-idx="${idx}">Remove</button>
        </div>
      `).join("");
      
      pendingList.innerHTML = cardsHtml || '<div id="pendingEmpty" style="color: #64748b;">No cards scanned yet.</div>';
      
      // Add remove handlers
      pendingList.querySelectorAll(".remove-pending").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const idx = parseInt(e.target.dataset.idx);
          pendingCards.splice(idx, 1);
          updatePendingUI();
        });
      });
    }

    function getROI() {
      const vw = liveCamera.videoWidth || 640;
      const vh = liveCamera.videoHeight || 480;
      const roiH = Math.round(vh * ROI_SCALE);
      const roiW = Math.round(roiH / 1.4);
      const x = Math.round((vw - roiW) / 2);
      const y = Math.round((vh - roiH) / 2);
      return { x, y, w: roiW, h: roiH, vw, vh };
    }

    function drawOverlay(hasMatch = false) {
      const { x, y, w, h, vw, vh } = getROI();
      
      liveOverlay.width = vw;
      liveOverlay.height = vh;
      overlayCtx.clearRect(0, 0, vw, vh);
      
      const color = hasMatch ? "#22c55e" : "#6366f1";
      
      // Draw ROI rectangle
      overlayCtx.strokeStyle = color;
      overlayCtx.lineWidth = 3;
      overlayCtx.strokeRect(x, y, w, h);
      
      // Corner markers
      const c = 25;
      overlayCtx.lineWidth = 5;
      // Top-left
      overlayCtx.beginPath();
      overlayCtx.moveTo(x, y + c); overlayCtx.lineTo(x, y); overlayCtx.lineTo(x + c, y);
      overlayCtx.stroke();
      // Top-right
      overlayCtx.beginPath();
      overlayCtx.moveTo(x + w - c, y); overlayCtx.lineTo(x + w, y); overlayCtx.lineTo(x + w, y + c);
      overlayCtx.stroke();
      // Bottom-left
      overlayCtx.beginPath();
      overlayCtx.moveTo(x, y + h - c); overlayCtx.lineTo(x, y + h); overlayCtx.lineTo(x + c, y + h);
      overlayCtx.stroke();
      // Bottom-right
      overlayCtx.beginPath();
      overlayCtx.moveTo(x + w - c, y + h); overlayCtx.lineTo(x + w, y + h); overlayCtx.lineTo(x + w, y + h - c);
      overlayCtx.stroke();
      
      // Instruction
      if (!hasMatch) {
        overlayCtx.font = "16px system-ui, sans-serif";
        overlayCtx.fillStyle = color;
        overlayCtx.textAlign = "center";
        overlayCtx.fillText("Hold card in frame", vw / 2, y + h + 30);
      }
    }

    function captureROI() {
      const { x, y, w, h, vw, vh } = getROI();
      liveCanvas.width = w;
      liveCanvas.height = h;
      const ctx = liveCanvas.getContext("2d");
      ctx.drawImage(liveCamera, x, y, w, h, 0, 0, w, h);
      return liveCanvas.toDataURL("image/jpeg", 0.85);
    }

    async function scanFrame() {
      if (isScanning || !cameraStream || confirmModal.style.display !== "none") return;
      
      isScanning = true;
      const imageData = captureROI();
      
      try {
        const resp = await fetch("/api/fast-match", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: imageData, threshold: MATCH_THRESHOLD }),
        });
        const data = await resp.json();
        
        if (data.matched) {
          // Check stability
          if (data.riftbound_id === lastMatchId) {
            matchCount++;
          } else {
            lastMatchId = data.riftbound_id;
            matchCount = 1;
          }
          
          drawOverlay(true);
          
          if (matchCount >= STABILITY_REQUIRED) {
            // Check if already in pending
            const alreadyPending = pendingCards.some(c => c.riftbound_id === data.riftbound_id);
            if (!alreadyPending) {
              currentMatch = data;
              showConfirmModal(data);
            } else {
              setStatus(`${data.name} already in pending list.`);
            }
          } else {
            setStatus(`Hold steady... (${matchCount}/${STABILITY_REQUIRED})`);
          }
        } else {
          lastMatchId = null;
          matchCount = 0;
          drawOverlay(false);
          setStatus("Scanning... hold card in frame.");
        }
      } catch (err) {
        console.error("Scan error:", err);
        setStatus("Scan error. Retrying...", true);
      }
      
      isScanning = false;
    }

    function showConfirmModal(match) {
      stopScanLoop();
      modalImage.src = match.image_url;
      modalTitle.textContent = match.name;
      modalMeta.textContent = `Distance: ${match.distance}`;
      confirmModal.style.display = "flex";
    }

    function closeConfirmModal() {
      confirmModal.style.display = "none";
      currentMatch = null;
      lastMatchId = null;
      matchCount = 0;
      if (cameraStream) {
        startScanLoop();
      }
    }

    function confirmMatch() {
      if (currentMatch) {
        pendingCards.push(currentMatch);
        updatePendingUI();
        setStatus(`Added "${currentMatch.name}" to pending.`);
      }
      closeConfirmModal();
    }

    function skipMatch() {
      setStatus("Skipped. Continue scanning.");
      closeConfirmModal();
    }

    async function startCamera() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false,
        });
        liveCamera.srcObject = cameraStream;
        await liveCamera.play();
        
        btnStart.disabled = true;
        btnStop.disabled = false;
        setStatus("Camera ready. Hold a card in the frame.");
        
        // Wait for video dimensions
        setTimeout(() => {
          drawOverlay(false);
          startScanLoop();
        }, 500);
      } catch (err) {
        setStatus("Camera access denied.", true);
        console.error(err);
      }
    }

    function stopCamera() {
      stopScanLoop();
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
      liveCamera.srcObject = null;
      btnStart.disabled = false;
      btnStop.disabled = true;
      overlayCtx.clearRect(0, 0, liveOverlay.width, liveOverlay.height);
      setStatus("Camera stopped.");
    }

    function startScanLoop() {
      if (scanTimer) return;
      scanTimer = setInterval(scanFrame, SCAN_INTERVAL);
    }

    function stopScanLoop() {
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
    }

    function clearPending() {
      pendingCards = [];
      updatePendingUI();
      setStatus("Pending list cleared.");
    }

    async function addToCollection() {
      if (!pendingCards.length) return;
      
      // Check if user is logged in
      const authResp = await fetch("/auth/me");
      const authData = await authResp.json();
      
      if (!authData.user) {
        collectionStatus.style.display = "block";
        collectionStatus.innerHTML = '<span style="color: #f87171;">Please log in to save to your collection.</span>';
        return;
      }
      
      // Get current collection
      const collResp = await fetch("/collection");
      const collData = await collResp.json();
      const existingCards = collData.cards || [];
      
      // Merge pending cards
      const cardMap = {};
      existingCards.forEach(c => {
        cardMap[c.card_key] = c;
      });
      
      pendingCards.forEach(pc => {
        if (cardMap[pc.riftbound_id]) {
          cardMap[pc.riftbound_id].count += 1;
        } else {
          cardMap[pc.riftbound_id] = {
            card_key: pc.riftbound_id,
            name: pc.name,
            image_url: pc.image_url,
            count: 1,
          };
        }
      });
      
      const cards = Object.values(cardMap).map(c => ({
        key: c.card_key,
        name: c.name,
        image_url: c.image_url,
        count: c.count,
      }));
      
      // Save
      const saveResp = await fetch("/collection", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cards }),
      });
      
      if (saveResp.ok) {
        const addedCount = pendingCards.length;
        pendingCards = [];
        updatePendingUI();
        collectionStatus.style.display = "block";
        collectionStatus.innerHTML = `<span style="color: #22c55e;">Added ${addedCount} card(s) to your collection!</span>`;
        setTimeout(() => { collectionStatus.style.display = "none"; }, 3000);
      } else {
        collectionStatus.style.display = "block";
        collectionStatus.innerHTML = '<span style="color: #f87171;">Failed to save. Please try again.</span>';
      }
    }

    // Event listeners
    btnStart.addEventListener("click", startCamera);
    btnStop.addEventListener("click", stopCamera);
    btnConfirmYes.addEventListener("click", confirmMatch);
    btnConfirmNo.addEventListener("click", skipMatch);
    btnClearPending.addEventListener("click", clearPending);
    btnAddToCollection.addEventListener("click", addToCollection);
    
    confirmModal.addEventListener("click", (e) => {
      if (e.target === confirmModal) skipMatch();
    });
    
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && confirmModal.style.display !== "none") {
        skipMatch();
      }
    });

    // Auto-start camera on load
    window.addEventListener("load", () => {
      updatePendingUI();
    });
  </script>
{% endblock %}
